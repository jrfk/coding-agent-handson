# 画像モザイク処理ツール設計書

## 概略設計

### システム構成
本ツールは以下のコンポーネントで構成されます：

1. **CLIインターフェース**：ユーザーからのコマンドライン引数を解析し、処理を実行
2. **画像処理エンジン**：モザイク処理のコア機能を提供
3. **顔検出モジュール**：（オプション機能）画像内の顔領域を検出

### アーキテクチャ
```
+----------------+      +-------------------+      +----------------+
| CLI Interface  | ---> | Image Processor   | ---> | Output Image   |
+----------------+      +-------------------+      +----------------+
                               |
                               v
                        +----------------+
                        | Face Detector  |
                        | (Optional)     |
                        +----------------+
```

## 機能設計

### モザイク処理機能
- 処理概要：入力画像を小さなブロックに分割し、各ブロック内の平均色で塗りつぶす
- アルゴリズム：
  1. 画像を読み込む
  2. モザイクの強さに応じてブロックサイズを決定
  3. 画像をブロックに分割
  4. 各ブロック内のピクセルの平均色を計算
  5. 各ブロックを平均色で塗りつぶす
  6. 処理後の画像を保存

### 顔認識モザイク機能（オプション）
- 処理概要：画像内の顔領域を検出し、その部分のみにモザイク処理を適用
- アルゴリズム：
  1. 画像を読み込む
  2. 顔検出アルゴリズムを使用して顔領域を検出
  3. 検出された顔領域のみにモザイク処理を適用
  4. 処理後の画像を保存

## クラス構成

### `MosaicTool` クラス
メインのエントリーポイントとなるクラスで、CLIコマンドの処理を行います。

#### 主なメソッド
- `parse_args()`: コマンドライン引数の解析
- `run()`: メイン処理の実行

### `ImageProcessor` クラス
画像処理のコア機能を提供するクラスです。

#### 主なメソッド
- `load_image(image_path)`: 画像の読み込み
- `apply_mosaic(image, strength)`: 画像全体にモザイク処理を適用
- `save_image(image, output_path)`: 処理後の画像の保存

### `FaceDetector` クラス
画像内の顔領域を検出するクラスです。

#### 主なメソッド
- `detect_faces(image)`: 画像内の顔領域の検出
- `apply_mosaic_to_faces(image, faces, strength)`: 検出された顔領域にモザイク処理を適用

## ファイル構成
```
src/
├── __init__.py
├── mosaic_tool.py      # MosaicTool クラスの実装
├── image_processor.py  # ImageProcessor クラスの実装
└── face_detector.py    # FaceDetector クラスの実装（オプション）

tests/
├── __init__.py
├── test_mosaic_tool.py
├── test_image_processor.py
└── test_face_detector.py

docs/
├── requirements.md     # 要件定義書
└── design.md           # 設計書（本ファイル）
```

## 依存ライブラリ
- Pillow (PIL): 基本的な画像処理
- OpenCV: 画像処理と顔検出（オプション）
- dlib: 高精度な顔検出（オプション）
- click: コマンドラインインターフェース
- pytest: テスト用フレームワーク

## インターフェース設計

### コマンドライン引数
```
Usage: mosaic_tool [OPTIONS] INPUT_IMAGE OUTPUT_IMAGE

Options:
  --strength INTEGER    モザイクの強さ（1-10、数値が大きいほど強い）
  --mode [full|face]    処理モード（full: 画像全体、face: 顔のみ）
  --help                ヘルプメッセージの表示
```

## エラーハンドリング
- 不正なファイル形式：適切なエラーメッセージを表示
- ファイルが存在しない：存在しないファイルパスが指定された場合のエラー処理
- 処理失敗：画像処理中のエラーハンドリング 
